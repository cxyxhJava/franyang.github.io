---
layout:     post
title:      Redis
subtitle:   Redis第二课--持久化
date:       2019-08-29
author:     程序猿小哈
header-img: img/redis.jpg
catalog: 	true
tags:
    - NoSql
    - 数据库
---

### Redis持久化

Redis作为一个键值对内存数据库(NoSQL)，数据都存储在内存当中，为了避免服务宕机导致的数据丢失，需要吧数据持久化到硬盘。

Redis提供了两种持久化方式`AOF`和`RDB`


#### AOF


#### RDB
RDB是一种快`照存储持久化方式`，具体就是将Redis某一时刻的内存数据保存到硬盘的文件当中，默认保存的文件名为`dump.rdb`，在Redis服务器启动时，重新加载dump.rdb文件的数据到内存当中恢复数据。


##### 开启RDB持久化方式
+ client端发送`save`命令
+ client端发送`bgsave`命令
+ 服务端配置文件指定触发RDB条件

save命令:服务器会阻塞save命令以后的其他客户端请求,等待数据同步完成后继续其他命令(redis是单线程的)

bgsave命令:异步操作,服务器会forks一个子进程来同步数据,同步完成后,子进程退出.主进程正常执行不受影响.(由于redis是单线程的,forks子进程的时候还是会阻塞)

服务器配置自动触发: redis.conf指定XX秒内执行XX次的XX命令  eg: save 300 10  # 300s内至少达至10条写命令就会开起rdb同步

##### RDB文件
RDB文件过程:<br>
  1. 生成临时RDB文件,并写入数据 
  2. 完成数据写入,用临时文件替代正式rdb文件
  3. 删除原来的rdb文件
 
RDB默认生成的文件名为dump.rdb(可以通过配置文件修改名称),文件过大时可以配置压缩,压缩文件.

```
# 是否压缩rdb文件
rdbcompression yes

# rdb文件的名称
dbfilename redis-6379.rdb

# rdb文件保存目录
dir ~/redis/
``` 

#### AOF(Append-only file)

AOF:记录客户端对服务端的每一次写操作命令,并将这些写操作以`Redis协议`追加保存到`.aof文件`末尾,在redis服务器重启时,会加载运行aof文件的命令,从而恢复数据

##### 开启AOF
redis默认不开启AOF,需要通过修改配置文件redis.conf开启,`异步操作,当写入aof文件是,forks子线程处理`
```
# 开启aof机制
appendonly yes

# aof文件名
appendfilename "appendonly.aof"

# 写入策略,always表示每个写操作都保存到aof文件中,也可以是everysec或no
appendfsync always

# 默认不重写aof文件
no-appendfsync-on-rewrite no

# 保存目录
dir ~/redis/

```
##### 三种写入策略

 1. always:没一个写操作都保存到aof文件中,安全,每个写请求都有IO消耗
 
 2. everysec: 默认写入策略,每秒一次写入aof文件
 
 3. no:redis服务器不负责写入aof,由操作系统来处理,更快但是不安全
 
##### AOF文件重写
AOF文件是吧每次写操作写在文件末尾,当同一个key多次写入的时候,其实只需要记录最后一次操作,就可以重写aof文件,只需要保存一条记录.


两种重写方式:<br>

1.配置文件设置 默认不开启,这种方式在每次fsync时都重写，影响服务器性以，因此默认值为no，不推荐使用。

```
# 默认不重写aof文件
no-appendfsync-on-rewrite no
```

2.客户端向服务器发送b`grewriteaof命令`

#### RDB和AOF的对比

![redis](/postImg/redis01.jpg)





 
  











  

  